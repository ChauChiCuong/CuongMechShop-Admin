<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel - Quản lý người dùng</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  ::-webkit-scrollbar-thumb {
    background-color: #2563eb;
    border-radius: 4px;
  }
  /* Sidebar */
  .sidebar {
    width: 280px;
    background: linear-gradient(135deg, #1e40af, #2563eb);
    color: white;
    position: fixed;
    top: 0; bottom: 0; left: 0;
    padding-top: 64px;
    transition: left 0.3s ease;
    z-index: 100;
    overflow-y: auto;
  }
  .sidebar.collapsed {
    left: -280px;
  }
  .sidebar a {
    display: flex;
    align-items: center;
    padding: 12px 24px;
    font-weight: 600;
    color: white;
    transition: background-color 0.3s ease;
  }
  .sidebar a:hover, .sidebar a.active {
    background-color: #3b82f6;
  }
  .sidebar .material-icons {
    margin-right: 16px;
  }

  /* Header */
  header {
    height: 64px;
    padding: 0 24px;
    background: rgba(255 255 255 / 0.3);
    backdrop-filter: blur(16px);
    position: fixed;
    top: 0; left: 280px; right: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 200;
    box-shadow: 0 1px 4px rgb(0 0 0 / 0.1);
  }
  header.collapsed {
    left: 0;
  }
  header .brand {
    font-weight: 700;
    font-size: 1.25rem;
    color: #1e40af;
  }

  /* Main content */
  main {
    margin-top: 64px;
    margin-left: 280px;
    padding: 24px;
    transition: margin-left 0.3s ease;
  }
  main.collapsed {
    margin-left: 0;
  }

  /* Table */
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
  }
  thead tr {
    background: #3b82f6;
    color: white;
  }
  th, td {
    text-align: left;
    padding: 12px 16px;
    border-bottom: 1px solid #e5e7eb;
  }
  tbody tr:hover {
    background: #eff6ff;
  }
  .action-btn {
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    transition: background-color 0.2s ease;
  }
  .action-btn.edit {
    color: #2563eb;
  }
  .action-btn.edit:hover {
    background-color: #dbeafe;
  }
  .action-btn.delete {
    color: #dc2626;
  }
  .action-btn.delete:hover {
    background-color: #fee2e2;
  }

  /* Toggle sidebar button */
  #toggleSidebarBtn {
    cursor: pointer;
    font-size: 28px;
    color: #1e40af;
  }

  /* Modal backdrop */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 500;
  }
  .modal-backdrop.active {
    display: flex;
  }

  /* Modal */
  .modal {
    background: white;
    border-radius: 12px;
    max-width: 480px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgb(59 130 246 / 0.5);
    padding: 24px;
    position: relative;
  }
  .modal header {
    font-weight: 700;
    font-size: 1.25rem;
    color: #1e40af;
    margin-bottom: 16px;
  }
  .modal .close-btn {
    position: absolute;
    top: 16px;
    right: 16px;
    font-size: 28px;
    cursor: pointer;
    color: #2563eb;
    transition: color 0.2s ease;
  }
  .modal .close-btn:hover {
    color: #1e40af;
  }

  /* Form inside modal */
  form label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #1e40af;
  }
  form input[type="text"],
  form input[type="number"],
  form input[type="email"],
  form input[type="password"],
  form select,
  form input[type="date"] {
    width: 100%;
    padding: 8px 12px;
    border: 1.5px solid #3b82f6;
    border-radius: 8px;
    font-size: 1rem;
    color: #1e40af;
    margin-bottom: 16px;
    transition: border-color 0.3s ease;
  }
  form input:focus,
  form select:focus {
    border-color: #60a5fa;
    outline: none;
    box-shadow: 0 0 6px rgba(96, 165, 250, 0.7);
  }
  form .password-toggle {
    position: absolute;
    right: 16px;
    top: 38px;
    color: #2563eb;
    cursor: pointer;
    user-select: none;
  }
  form .password-container {
    position: relative;
  }

  form .btn-group {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
  }
  form button {
    padding: 10px 20px;
    border-radius: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  form button.cancel-btn {
    background: #dc2626;
    color: white;
  }
  form button.cancel-btn:hover {
    background: #b91c1c;
  }
  form button.save-btn {
    background: #2563eb;
    color: white;
  }
  form button.save-btn:hover {
    background: #1e40af;
  }

  /* Pagination */
  .pagination {
    margin-top: 24px;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }
  .pagination button {
    padding: 8px 14px;
    border: 1.5px solid #2563eb;
    border-radius: 6px;
    background: white;
    color: #2563eb;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  .pagination button:hover:not(:disabled) {
    background: #dbeafe;
  }
  .pagination button:disabled {
    cursor: not-allowed;
    opacity: 0.4;
  }

  /* Login overlay */
  .login-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.9);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* Toast notification */
  #toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: #2563eb;
    color: white;
    padding: 12px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(37, 99, 235, 0.7);
    opacity: 0;
    transform: translateY(40px);
    transition: opacity 0.3s ease, transform 0.3s ease;
    z-index: 999;
    pointer-events: none;
  }
  #toast.show {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }
</style>
</head>
<body class="bg-gray-100 font-sans">

<!-- Sidebar -->
<nav id="sidebar" class="sidebar" aria-label="Navigation Sidebar">
  <div class="px-6 py-4 font-bold text-xl select-none">Cuong Mech Admin</div>
  <a href="#" class="active" aria-current="page">
    <span class="material-icons" aria-hidden="true">people</span> Quản lý người dùng
  </a>
  <!-- Add more sidebar links as needed -->
  <button id="logoutBtn" class="mt-auto w-full py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-b-lg">
    <span class="material-icons align-middle">logout</span> Đăng xuất
  </button>
</nav>

<!-- Header -->
<header id="header" class="">
  <span id="toggleSidebarBtn" class="material-icons" aria-label="Toggle Sidebar" role="button" tabindex="0" 
        title="Ẩn/Hiện menu điều hướng">menu</span>
  <div class="brand">Cuong Mech Shop - Admin Panel</div>
  <div id="adminUserInfo" class="font-semibold text-blue-700"></div>
</header>

<!-- Main Content -->
<main id="mainContent">
  <!-- Toolbar -->
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-900 select-none">Quản lý người dùng</h1>
    <button id="addUserBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-semibold flex items-center gap-2 transition">
      <span class="material-icons">add</span> Thêm người dùng mới
    </button>
  </div>

  <!-- Search -->
  <input id="searchInput" type="search" placeholder="Tìm kiếm theo tên, username, email..." 
         class="w-full max-w-md mb-4 p-3 border border-blue-300 rounded-lg outline-none transition focus:border-blue-600" />

  <!-- Users Table -->
  <div class="overflow-auto rounded-lg shadow border border-blue-200 bg-white">
    <table role="grid" aria-label="Danh sách người dùng" class="min-w-full divide-y divide-blue-200">
      <thead class="bg-blue-600 text-white select-none">
        <tr>
          <th class="p-3 text-left" scope="col">ID</th>
          <th class="p-3 text-left" scope="col">Device ID</th>
          <th class="p-3 text-center" scope="col">VIP</th>
          <th class="p-3 text-left" scope="col">Họ & Tên / Username</th>
          <th class="p-3 text-left" scope="col">Thông tin Zalo / Rank</th>
          <th class="p-3 text-left" scope="col">Email</th>
          <th class="p-3 text-left" scope="col">Role</th>
          <th class="p-3 text-left" scope="col">Trạng thái</th>
          <th class="p-3 text-center" scope="col">Hành động</th>
        </tr>
      </thead>
      <tbody id="userTableBody" class="divide-y divide-blue-100"></tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination mt-6">
    <button id="prevPageBtn" disabled aria-label="Trang trước">Trước</button>
    <button id="nextPageBtn" disabled aria-label="Trang tiếp theo">Sau</button>
  </div>
</main>

<!-- Modal Thêm/Sửa Người Dùng -->
<div id="userModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal">
    <header id="modalTitle">Thêm người dùng mới</header>
    <button class="close-btn" aria-label="Đóng modal" id="closeUserModalBtn">&times;</button>
    <form id="userForm" novalidate>
      <input type="hidden" id="userId" />
      <label for="deviceId">Device ID</label>
      <input type="text" id="deviceId" name="deviceId" autocomplete="off" />

      <label for="firstName">Họ</label>
      <input type="text" id="firstName" name="firstName" required autocomplete="off" />

      <label for="lastName">Tên</label>
      <input type="text" id="lastName" name="lastName" required autocomplete="off" />

      <label for="username">Username</label>
      <input type="text" id="username" name="username" required autocomplete="off" />

      <label for="email">Email</label>
      <input type="email" id="email" name="email" required autocomplete="off" />

      <label for="zaloPhone">Số điện thoại Zalo</label>
      <input type="text" id="zaloPhone" name="zaloPhone" autocomplete="off" />

      <label for="currentRank">Rank hiện tại</label>
      <input type="text" id="currentRank" name="currentRank" autocomplete="off" />

      <label for="currentLevel">Lv. hiện tại</label>
      <input type="number" id="currentLevel" name="currentLevel" min="0" autocomplete="off" />

      <label for="password">Password</label>
      <div class="password-container">
        <input type="password" id="password" name="password" placeholder="Nhập mật khẩu" autocomplete="new-password" />
        <span class="password-toggle" onclick="togglePasswordVisibility('password')">&#xe8f4;</span>
      </div>

      <label for="role">Role</label>
      <select id="role" name="role" required>
        <option value="player">Player</option>
        <option value="admin">Admin</option>
      </select>

      <label for="vipExpiry">VIP Expiry Date</label>
      <input type="date" id="vipExpiry" name="vipExpiry" />

      <label>Trạng thái</label>
      <div>
        <label><input type="radio" name="status" value="active" checked /> Active</label>
        <label class="ml-4"><input type="radio" name="status" value="inactive" /> Inactive</label>
        <label class="ml-4"><input type="radio" name="status" value="banned" /> Banned</label>
      </div>

      <div class="btn-group">
        <button type="button" class="cancel-btn" id="cancelUserBtn">Hủy</button>
        <button type="submit" class="save-btn">Lưu</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Xác nhận xóa -->
<div id="deleteModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="deleteModalTitle">
  <div class="modal max-w-sm p-6">
    <header id="deleteModalTitle" class="font-bold text-lg text-red-600 mb-4">Xác nhận xóa người dùng</header>
    <p>Bạn có chắc muốn xóa người dùng này? Hành động không thể hoàn tác.</p>
    <div class="btn-group mt-6">
      <button class="cancel-btn" id="cancelDeleteBtn">Hủy</button>
      <button class="save-btn bg-red-600 hover:bg-red-700" id="confirmDeleteBtn">Xóa</button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" role="alert" aria-live="assertive" aria-atomic="true"></div>

<script>
  const apiBase = 'http://localhost:3000/api';
  let users = [];
  let currentPage = 1;
  const itemsPerPage = 8;
  let filteredUsers = [];

  let userToDeleteId = null;

  // Elements
  const sidebar = document.getElementById('sidebar');
  const header = document.getElementById('header');
  const mainContent = document.getElementById('mainContent');
  const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
  const userTableBody = document.getElementById('userTableBody');
  const addUserBtn = document.getElementById('addUserBtn');
  const searchInput = document.getElementById('searchInput');
  const prevPageBtn = document.getElementById('prevPageBtn');
  const nextPageBtn = document.getElementById('nextPageBtn');
  const userModalBackdrop = document.getElementById('userModalBackdrop');
  const userForm = document.getElementById('userForm');
  const closeUserModalBtn = document.getElementById('closeUserModalBtn');
  const cancelUserBtn = document.getElementById('cancelUserBtn');
  const deleteModalBackdrop = document.getElementById('deleteModalBackdrop');
  const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
  const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
  const toast = document.getElementById('toast');
  const logoutBtn = document.getElementById('logoutBtn');
  const adminUserInfo = document.getElementById('adminUserInfo');

  // Toggle sidebar
  toggleSidebarBtn.addEventListener('click', () => {
    sidebar.classList.toggle('collapsed');
    header.classList.toggle('collapsed');
    mainContent.classList.toggle('collapsed');
  });
  toggleSidebarBtn.addEventListener('keypress', (e) => {
    if(e.key === 'Enter' || e.key === ' ') toggleSidebarBtn.click();
  });

  // Show toast notifications
  function showToast(message, duration = 3000) {
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => {
      toast.classList.remove('show');
    }, duration);
  }

  // Password toggle
  function togglePasswordVisibility(fieldId) {
    const field = document.getElementById(fieldId);
    const toggleSpan = field.nextElementSibling;
    if (field.type === 'password') {
      field.type = 'text';
      toggleSpan.textContent = '\uE8F5'; // visibility_off
    } else {
      field.type = 'password';
      toggleSpan.textContent = '\uE8F4'; // visibility
    }
  }

  // Check admin login session
  async function checkAdminLogin() {
    try {
      const res = await fetch(`${apiBase}/me`, { credentials: 'include' });
      if (!res.ok) throw new Error('Chưa đăng nhập');
      const data = await res.json();
      if (!data.user || data.user.role !== 'admin') throw new Error('Không có quyền truy cập');
      adminUserInfo.textContent = `Xin chào, ${data.user.username}`;
      return true;
    } catch {
      // Create overlay
      const overlay = document.createElement('div');
      overlay.className = 'login-overlay';
      overlay.innerHTML = `
        <div style="text-align: center; color: white; padding: 20px;">
          <h2 style="font-size: 24px; margin-bottom: 20px;">Bạn cần đăng nhập Admin để truy cập trang này</h2>
          <p style="margin-bottom: 20px;">Đang chuyển hướng đến trang đăng nhập...</p>
        </div>
      `;
      document.body.appendChild(overlay);
      
      setTimeout(() => {
        window.location.href = 'https://chauchicuong.github.io/CuongMechShop-signin/';
      }, 2000);
      return false;
    }
  }

  // Load users from backend
  async function loadUsers() {
    try {
      const res = await fetch(`${apiBase}/users`, { credentials: 'include' });
      if (!res.ok) throw new Error('Không thể tải danh sách người dùng');
      users = await res.json();
      filteredUsers = [...users];
      currentPage = 1;
      renderUsers();
    } catch (err) {
      alert(err.message);
    }
  }

  // Render users table with pagination and search filtering
  function renderUsers() {
    userTableBody.innerHTML = '';
    if (filteredUsers.length === 0) {
      userTableBody.innerHTML = `<tr><td colspan="9" class="p-6 text-center text-gray-400">Không có người dùng</td></tr>`;
      prevPageBtn.disabled = true;
      nextPageBtn.disabled = true;
      return;
    }
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, filteredUsers.length);
    const pageUsers = filteredUsers.slice(startIndex, endIndex);

    pageUsers.forEach(user => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="p-3 text-gray-600">${user.id}</td>
        <td class="p-3">${user.deviceId || 'N/A'}</td>
        <td class="p-3 text-center">
          <input type="checkbox" ${user.vip ? 'checked' : ''} onchange="toggleVIP('${user.id}', this.checked)" aria-label="Toggle VIP status for ${user.username}" />
        </td>
        <td class="p-3 font-semibold">${(user.firstName || '') + ' ' + (user.lastName || '')}<br/><small class="text-gray-500">${user.username}</small></td>
        <td class="p-3">${user.zaloPhone || 'N/A'}<br/><small class="text-gray-500">${user.currentRank || ''} (Lv. ${user.currentLevel || '0'})</small></td>
        <td class="p-3">${user.email}</td>
        <td class="p-3">
          <span class="px-2 py-0.5 rounded-full text-xs ${user.role === 'admin' ? 'bg-purple-200 text-purple-800' : 'bg-green-200 text-green-800'}">${user.role}</span>
        </td>
        <td class="p-3">
          <span class="px-2 py-0.5 rounded-full text-xs ${user.status === 'active' ? 'bg-green-200 text-green-800' : user.status === 'banned' ? 'bg-gray-300 text-gray-700' : 'bg-red-200 text-red-800'}">${user.status}</span>
        </td>
        <td class="p-3 text-center space-x-2">
          <button class="action-btn edit" aria-label="Chỉnh sửa user ${user.username}" onclick="editUser('${user.id}')"><span class="material-icons">edit</span></button>
          <button class="action-btn delete" aria-label="Xóa user ${user.username}" onclick="confirmDeleteUser('${user.id}')"><span class="material-icons">delete</span></button>
        </td>
      `;
      userTableBody.appendChild(tr);
    });

    prevPageBtn.disabled = currentPage === 1;
    nextPageBtn.disabled = currentPage * itemsPerPage >= filteredUsers.length;
  }

  // Search input event
  searchInput.addEventListener('input', () => {
    const val = searchInput.value.toLowerCase().trim();
    filteredUsers = users.filter(u =>
      (u.firstName + ' ' + u.lastName).toLowerCase().includes(val) ||
      (u.username && u.username.toLowerCase().includes(val)) ||
      (u.email && u.email.toLowerCase().includes(val))
    );
    currentPage = 1;
    renderUsers();
  });

  prevPageBtn.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderUsers();
    }
  });
  nextPageBtn.addEventListener('click', () => {
    if(currentPage * itemsPerPage < filteredUsers.length) {
      currentPage++;
      renderUsers();
    }
  });

  // Toggle VIP status
  async function toggleVIP(id, checked) {
    try {
      const res = await fetch(`${apiBase}/users/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        credentials: 'include',
        body: JSON.stringify({vip: checked})
      });
      if(!res.ok) throw new Error('Cập nhật VIP thất bại');
      showToast('Cập nhật VIP thành công');
      loadUsers();
    } catch (err) {
      alert(err.message);
      loadUsers();
    }
  }
  window.toggleVIP = toggleVIP;

  // Show modal add new user
  addUserBtn.addEventListener('click', () => {
    openUserModal();
  });

  // Open user modal - thêm hoặc sửa
  function openUserModal(user = null) {
    userModalBackdrop.classList.add('active');
    userForm.reset();
    if (user) {
      document.getElementById('modalTitle').textContent = 'Chỉnh sửa người dùng';
      userForm.userId.value = user.id || '';
      userForm.deviceId.value = user.deviceId || '';
      userForm.firstName.value = user.firstName || '';
      userForm.lastName.value = user.lastName || '';
      userForm.username.value = user.username || '';
      userForm.email.value = user.email || '';
      userForm.zaloPhone.value = user.zaloPhone || '';
      userForm.currentRank.value = user.currentRank || '';
      userForm.currentLevel.value = user.currentLevel || '';
      userForm.password.value = ''; // Không tự động hiển thị mật khẩu cũ
      userForm.role.value = user.role || 'player';
      userForm.status.value = user.status || 'active';
      userForm.vipExpiry.value = user.vipExpiry || '';
    } else {
      document.getElementById('modalTitle').textContent = 'Thêm người dùng mới';
      userForm.userId.value = '';
    }
  }

  closeUserModalBtn.addEventListener('click', () => {
    userModalBackdrop.classList.remove('active');
  });
  cancelUserBtn.addEventListener('click', () => {
    userModalBackdrop.classList.remove('active');
  });

  // Gửi form thêm/sửa user
  userForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const userId = userForm.userId.value.trim();
    const payload = {
      deviceId: userForm.deviceId.value.trim(),
      firstName: userForm.firstName.value.trim(),
      lastName: userForm.lastName.value.trim(),
      username: userForm.username.value.trim(),
      email: userForm.email.value.trim(),
      zaloPhone: userForm.zaloPhone.value.trim(),
      currentRank: userForm.currentRank.value.trim(),
      currentLevel: userForm.currentLevel.value.trim(),
      password: userForm.password.value,
      role: userForm.role.value,
      status: userForm.status.value,
      vipExpiry: userForm.vipExpiry.value
    };
    // Validate minimal
    if (!payload.username || !payload.email) {
      alert('Username và Email là bắt buộc');
      return;
    }

    try {
      const res = await fetch(`${apiBase}/users${userId ? '/' + userId : ''}`, {
        method: userId ? 'PUT' : 'POST',
        credentials: 'include',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const errData = await res.json();
        throw new Error(errData.error || 'Lỗi lưu dữ liệu');
      }
      userModalBackdrop.classList.remove('active');
      showToast(`Người dùng đã được ${userId ? 'cập nhật' : 'thêm'} thành công`);
      loadUsers();
    } catch (err) {
      alert(err.message);
    }
  });

  // Sửa người dùng
  function editUser(id) {
    const user = users.find(u => u.id === id);
    if (!user) {
      alert('Người dùng không tồn tại');
      return;
    }
    openUserModal(user);
  }
  window.editUser = editUser;

  // Xác nhận xóa người dùng
  function confirmDeleteUser(id) {
    userToDeleteId = id;
    deleteModalBackdrop.classList.add('active');
  }
  window.confirmDeleteUser = confirmDeleteUser;

  // Hủy xóa
  cancelDeleteBtn.addEventListener('click', () => {
    deleteModalBackdrop.classList.remove('active');
    userToDeleteId = null;
  });

  // Xác nhận xóa
  confirmDeleteBtn.addEventListener('click', async () => {
    if (!userToDeleteId) return;
    try {
      const res = await fetch(`${apiBase}/users/${userToDeleteId}`, {
        method: 'DELETE',
        credentials: 'include'
      });
      if (!res.ok) throw new Error('Xóa thất bại');
      showToast('Người dùng đã bị xóa');
      deleteModalBackdrop.classList.remove('active');
      loadUsers();
      userToDeleteId = null;
    } catch (err) {
      alert(err.message);
    }
  });

  // Logout admin
  logoutBtn.addEventListener('click', async () => {
    if (!confirm('Bạn chắc chắn muốn đăng xuất?')) return;
    try {
      const res = await fetch(`${apiBase}/logout`, {
        method: 'POST',
        credentials: 'include'
      });
      if (!res.ok) throw new Error('Đăng xuất thất bại');
      window.location.href = '/admin-login.html';
    } catch (err) {
      alert('Lỗi đăng xuất: ' + err.message);
    }
  });

  // Khởi tạo
  (async () => {
    if(await checkAdminLogin()) {
      loadUsers();
    }
  })();
</script>
</body>
</html>

